# 功能規格：重構魚類資料控制器（FishController）— 以 TDD 驅動

**Feature Branch**：`001-refactor-fish-controller`  
**Created**：2025-10-29  
**Status**：Draft  
**Input**：重構現有專案，先以後端 Laravel 的程式碼為主要重構項目；FishController 過於雜亂，先從此處開始；每次重構都要符合 TDD 原則。

決策（澄清結果）

- 範圍（Q1=A）：僅涵蓋「查詢端點」（讀取），不處理建立/更新/刪除。
- 輸出相容性（Q2=C）：允許為改善而調整回應結構與欄位命名，但需同步前端/文件。
- 測試門檻（Q3=B）：不設硬性覆蓋率數值，以風險導向清單為準（關鍵路徑必測）。

## 使用情境與測試（必填）

### User Story 1 — 取得魚類清單（P1）

使用者請求魚類清單，可取得列表並看到正確的圖片/音檔 URL 欄位（音檔可為空）。

為何 P1：列表是最常用的瀏覽入口，影響整體 UX 與效能。

獨立測試：呼叫清單端點，驗證回傳結構、每筆資料的圖片 URL 與（可能為 null 的）音檔 URL。

Acceptance Scenarios：

1. Given 有多筆魚類資料，When 請求清單，Then 回傳排序正確的資料列。
2. Given 某筆資料無音檔，When 請求清單，Then 對應欄位為 null（不丟例外）。

---

### User Story 2 — 取得單筆魚類詳細（P1）

使用者提供 ID，取得單筆魚類資料與媒體 URL。

為何 P1：是列表到詳情的核心流程。

獨立測試：呼叫詳情端點，驗證欄位完整性、圖片 URL 與音檔 URL 規則。

Acceptance Scenarios：

1. Given 有有效 ID，When 請求詳情，Then 回傳該筆資料且圖片 URL 正確、音檔 URL 依規則（可為 null）。
2. Given 無效 ID，When 請求詳情，Then 回應資源不存在錯誤（HTTP 404 與一致錯誤格式）。

---

### User Story 3 — 條件查詢/篩選（如關鍵字、更新時間）（P2）

使用者可依條件過濾清單（例如 since 參數、關鍵字）。

為何 P2：提高可用性與資料探索效率。

獨立測試：呼叫清單端點附帶查詢參數，驗證濾出的資料與分頁/排序是否符合預期。

Acceptance Scenarios：

1. Given since 參數，When 請求清單，Then 僅回傳在該時間之後更新的資料。
2. Given 關鍵字，When 請求清單，Then 僅回傳名稱或描述符合者。

---

### 邊界情境

- 資料無圖片：應回傳預設圖片 URL（例如 `default.png`）。
- 資料無音檔：音檔 URL 欄位為 null；不得調用外部服務以 null 作為檔名。
- 關聯未載入或為空：不得拋出例外，回傳安全的預設值。
- 無效參數（例如負值 ID、錯誤格式 since）：回傳一致的驗證錯誤格式。

## 需求（必填）

### 功能性需求

- FR-001：控制器僅負責協調與輸入/輸出，商業邏輯（圖片/音檔 URL 組裝、查詢條件）下沉至服務層（例如 `App\Services\FishService` 等）。
- FR-002：查詢端點（清單、單筆）維持行為一致，但允許為改善而調整輸出欄位命名/結構；變更需同步文件/前端。
- FR-003：媒體 URL 規則：
  - 圖片欄位為空時，使用預設圖片名稱（如 `default.png`）產生 URL。
  - 音檔欄位為空或 null 時，音檔 URL 為 null，且不得呼叫 URL 產生服務。
  - 僅在檔名為「非空字串」時呼叫 `SupabaseStorageService::getUrl(type, filename)`。
- FR-004：為避免 N+1，應使用必要的 eager loading 或服務端拼接策略。
- FR-005：錯誤處理一致：
  - 找不到資源 → 404 與一致錯誤格式。
  - 驗證錯誤（參數格式不正確等）→ 422 與一致錯誤格式。
- FR-006：日誌在雲平台/唯讀檔案系統時不可寫入 `storage/logs`；使用平台建議的通道（例如 `errorlog`）。
- FR-007：所有新增或變更需以 TDD 進行：先寫測試（Red），最小實作（Green），再重構（Refactor）。

### 重要實體

- Fish：基本屬性與媒體欄位（圖片檔名、音檔檔名可能為空）。
- 查詢條件：since、關鍵字（如有）、排序/分頁（如有）。
- 回應物件：資料列/單筆資料與媒體 URL 欄位（圖片必有、音檔可為 null）。

## 成功準則（必填）

### 可衡量結果

- SC-001：上述 P1/P2 使用情境的驗收測試 100% 通過。
- SC-002：媒體 URL 邏輯對所有邊界情境皆有測試覆蓋，且不再出現以 null 呼叫 URL 服務的例外。
- SC-003：重構後 Controller 行數/責任明顯下降（邏輯移至 Service），PR 可讀性提升（由 Reviewer 主觀評估）。
- SC-004：CI 在 PR 上穩定執行測試，無間歇性失敗；回歸缺陷為零於當次迭代。
