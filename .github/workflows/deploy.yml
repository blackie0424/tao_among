name: Deploy to EC2 (Rsync Version)

on:
  push:
    branches:
      - main

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºç¨‹å¼ç¢¼
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. PHP å‰ç½®ä½œæ¥­ (æ¸¬è©¦ç”¨)
      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.3"
          extensions: mbstring, xml, pgsql, sqlite3, pdo_sqlite
          coverage: none

      - name: Install Composer dependencies
        run: composer install --no-interaction --prefer-dist

      - name: Copy .env for testing
        run: cp .env.testing .env

      - name: Generate application key
        run: php artisan key:generate

      # 3. å‰ç«¯å»ºæ§‹
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install Node.js dependencies
        run: npm ci

      - name: Build frontend assets
        run: npm run build

      # 4. Rsync éƒ¨ç½²å‰ç«¯è³‡æº (é—œéµä¿®æ”¹)
      - name: Sync assets to EC2
        uses: easingthemes/ssh-deploy@main
        with:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          ARGS: "-avz --delete"
          SOURCE: "public/build/"
          REMOTE_HOST: ${{ secrets.EC2_HOST }}
          REMOTE_USER: ${{ secrets.EC2_USERNAME }}
          # âš ï¸ è«‹å°‡ your-project ä¿®æ”¹ç‚ºä½ å¯¦éš›çš„ç›®éŒ„åç¨±
          TARGET: "/var/www/html/tao_among/public/build/"
          SCRIPT_BEFORE: "mkdir -p /var/www/html/tao_among/public/build"

      # 5. SSH é€£ç·šåŸ·è¡Œéƒ¨ç½²æŒ‡ä»¤
      - name: Execute remote commands via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e  #
            PROJECT_PATH="/var/www/tao_among" # âš ï¸ è«‹ä¿®æ”¹é€™è£¡

            echo "ğŸš€ é–‹å§‹éƒ¨ç½²å¾Œç«¯é‚è¼¯..."
            cd $PROJECT_PATH

            # æ‹‰å–æœ€æ–°ç¨‹å¼ç¢¼ (ä¸åŒ…å«å·²è¢« ignore çš„ public/buildï¼Œæ‰€ä»¥ä¸æœƒè¡çª)
            git pull origin main

            # å®‰è£ä¾è³´
            composer install --no-dev --no-interaction --prefer-dist --optimize-autoloader

            # åŸ·è¡Œé·ç§»èˆ‡å„ªåŒ–
            php artisan migrate --force
            php artisan config:cache
            php artisan event:cache
            php artisan route:cache
            php artisan view:cache

            # ç¢ºä¿æ¬Šé™
            sudo chown -R ec2-user:nginx storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            # é‡å•Ÿæœå‹™
            sudo systemctl reload php-fpm

            echo "âœ… éƒ¨ç½²å®Œæˆï¼"
